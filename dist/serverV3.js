!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/Users/adam/Programming/spaceTrash/src/node-express-passport-mongoose-auth",r(r.s=11)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t,r){var n=r(0),o=new n.Schema({name:String,x:Number,y:Number,x2:Number,y2:Number}),s=new n.Schema({name:String,x:Number,y:Number}),i=new n.Schema({name:String,rooms:[o],doors:[s]},{usePushEach:!0});i.virtual("shipMap").get((function(){if(this.rooms.length){var e={},t=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;this.rooms.forEach(e=>{for(var s=e.x;s<e.x2+2;s++)s<=t&&(t=s-1),s>=n&&(n=s+1);for(s=e.y;s<e.y2+2;s++)s<=r&&(r=s-1),s>=o&&(o=s+1)});for(var s=t;s<n;s++){e[s]=void 0===e[s]?{}:e[s];for(var i=r;i<o;i++)e[s][i]=" "}return this.rooms.forEach(t=>{for(var r=t.x;r<t.x2+1;r++)e[r]=void 0===e[r]?{}:e[r],e[r][t.y]="B",e[r][t.y2]="B";for(r=t.y;r<t.y2+1;r++)e[t.x]=void 0===e[t.x]?{}:e[t.x],e[t.x2]=void 0===e[t.x2]?{}:e[t.x2],e[t.x][r]="B",e[t.x2][r]="B";for(var n=t.x+1;n<t.x2;n++)for(var o=t.y+1;o<t.y2;o++)e[n][o]="f"}),this.doors.forEach(t=>{e[t.x][t.y]="d"}),{status:"ok",gridMap:e,xMin:t,xMax:n,yMin:r,yMax:o}}return{status:"no rooms"}})),e.exports=n.model("Ship",i)},function(e,t,r){var n=r(0),o=n.Schema,s=r(15),i=new o({username:String,password:String,name:String});i.plugin(s),e.exports=n.model("User",i)},function(e,t,r){var n=r(0),o=new n.Schema({name:String,x:Number,y:Number,direction:Number,ship:String,user:String});e.exports=n.model("Drone",o)},function(e,t){e.exports=require("http")},function(e,t,r){var n=r(0),o=new n.Schema({users:Array,chatLog:Array,name:String,gameState:{shipsWithoutFogOfWar:Array,dronesWithoutRays:Array}});e.exports=n.model("Session",o)},function(e,t,r){const n=r(8),o=r(16),s=(e,t)=>{e.gameState.shipsWithoutFogOfWar;e.gameState,e.userStates;var r=[];Object.keys(t).forEach(e=>{const n=t[e].map(t=>({droneId:e,timestamp:t.timestamp,instruction:t.instruction}));r=r.concat(n)});const n=r.sort(e=>e.timestamp);o(e,n)},i=e=>e.gameState.dronesWithoutRays.map(t=>{const r=e.gameState.shipsWithoutFogOfWar.filter(e=>t.ship===e.id)[0];return t.rays=n(t,r.matrix),t});e.exports={initializeState:(e,t,r)=>{((e,t,r)=>{const n={shipsWithoutFogOfWar:t.map(e=>{if(e.shipMap.gridMap){const n=e.shipMap.yMax-e.shipMap.yMin,o=e.shipMap.xMax-e.shipMap.xMin,s=2,i=new Array(n).fill("_").map(()=>new Array(o).fill("_").map(()=>new Array(s).fill("_")));for(var t=0;t<n;t++)for(var r=0;r<o;r++){const n=r+e.shipMap.xMin,o=t+e.shipMap.yMin;e.shipMap.gridMap[n][o]&&(i[t][r][0]=e.shipMap.gridMap[n][o])}e.matrix=i}return e}).map(e=>(e.matrix&&r.filter(t=>t.ship===e.id).forEach(t=>{e.matrix[Math.round(t.y)][Math.round(t.x)][1]=`drone-${t.id}`}),e)).map(e=>(e.x=0,e.y=0,e)),dronesWithoutRays:r};e.gameState=n})(e,t,r),(e=>{const t={};e.gameState.dronesWithoutRays.forEach(e=>{t[e.id]=[{instruction:"NO_OP",timestamp:Date.now()}]}),s(e,t),i(e)})(e)},updateState:(e,t)=>(s(e,t),{dronesWithRays:i(e)})}},function(e,t){var r=60*Math.PI/180;const n=Math.ceil(320);const o=160/Math.tan(r/2),s=2*Math.PI;e.exports=(e,t)=>{const r=t.length,i=t[0].length,a=t;return Array.from(Array(n).keys()).map((t,u)=>{var c=1*(-n/2+t),d=Math.sqrt(c*c+o*o),f=Math.asin(c/d);f+=e.direction;const p={id:u,style:{position:"absolute",src:"/walls_3.png",height:0,width:0,left:0,top:0,zIndex:0,clip:""},rayDistance:0,x:0,y:0};(f%=s)<0&&(f+=s);for(var l,m=f>.75*s||f<.25*s,h=f<0||f>Math.PI,g=Math.sin(f),y=Math.cos(f),x=0,v=0,S=0,M=!1,w=m?1:-1,b=w*(N=g/y),I=m?Math.ceil(e.x):Math.floor(e.x),O=e.y+(I-e.x)*N;I>=0&&I<i&&O>=0&&O<r;){const t=I+(m?0:-1)>>0,r=O>>0;if(a[r]&&a[r][t]&&"f"!==a[r][t][0]){x=(R=I-e.x)*R+(A=O-e.y)*A,l=O%1,m||(l=1-l),I,O,v=t,S=r,M=!0,!0;break}I+=w,O+=b}var N,_=h?-1:1,E=_*(N=y/g);for(O=h?Math.floor(e.y):Math.ceil(e.y),I=e.x+(O-e.y)*N;I>=0&&I<i&&O>=0&&O<r;){const t=O+(h?-1:0)>>0,r=I>>0;if("f"!==a[t][r][0]){var R,A,T=(R=I-e.x)*R+(A=O-e.y)*A;(!x||T<x)&&(x=T,I,O,v=r,S=t,l=I%1,h&&(l=1-l),M=!1);break}I+=E,O+=_}if(x){"d"===a[S][v][0]&&(p.style.src="/walls_4.png"),p.brenshams=((e,t,r,n,o)=>{var s=Math.abs(r-e),i=Math.abs(n-t),a=e<r?1:-1,u=t<n?1:-1,c=s-i;const d=[];for(;d.push({x:e,y:t,tile:o[t][e]}),e!==r||t!==n;){var f=2*c;f>-i&&(c-=i,e+=a),f<s&&(c+=s,t+=u)}return d})(Math.round(e.x),Math.round(e.y),v,S,a),x=Math.sqrt(x),x*=Math.cos(e.direction-f),p.rayDistance=x;var j=Math.round(o/x),D=1*j,W=Math.round((200-j)/2),B=Math.round(l*D);B>D-1&&(B=D-1),B+=M?D:0,p.style.height=j,p.style.width=2*D>>0,p.style.top=W-0,p.style.left=1*u-B,p.style.clip="rect(0px, "+(B+1)+"px, "+(0+j)+"px, "+B+"px)";var U=v-e.x,q=S-e.y,P=U*U+q*q;return p.style.zIndex=-1e3*P>>0,p.x=v,p.y=S,p}return p})}},function(e,t){e.exports=require("passport")},function(e,t,r){r(0);var n=r(9),o=r(3),s={home:function(e,t){t.render("index",{user:e.user})},register:function(e,t){t.render("register")},doRegister:function(e,t){o.register(new o({username:e.body.username,name:e.body.name}),e.body.password,(function(r,o){if(r)return t.render("register",{user:o});n.authenticate("local")(e,t,(function(){t.redirect("/")}))}))},login:function(e,t){t.render("login")},doLogin:function(e,t){n.authenticate("local")(e,t,(function(){t.redirect("/")}))},logout:function(e,t){e.logout(),t.redirect("/")},allUsers:function(e,t){o.find({},(function(r,n){t.render("allUsers",{allUsers:n,user:e.user})}))}};e.exports=s},function(e,t,r){r(12),r(13),e.exports=r(18)},function(e,t,r){var n=r(0);n.Promise=global.Promise,n.connect("mongodb://localhost/node-auth").then(()=>console.log("connection succesful")).catch(e=>console.error(e))},function(e,t,r){const n=r(5),o=r(14),s=r(4),i=r(6),a=r(2),u=(r(3),r(7)),c=(r(8),n.createServer({}));c.listen(5e3,()=>console.log("Web server start. http://localhost:5000"));const d=new o.Server({server:c});d.on("connection",e=>{e.send(JSON.stringify({msg:"user joined"})),console.log("connected"),e.room=[],e.on("error",e=>console.log(e)),e.on("close",e=>console.log("websocket closed"+e)),e.on("message",t=>{Date.now();var r=JSON.parse(t);if(r.createdAt=new Date,r.join&&e.room.push(r.join),r.room&&r.msg){const e=r.room.split("-");"session"===e[0]&&("user"===e[2]?r.msg.load?i.findById(e[1],(e,t)=>{p(t,t.gameState,r.msg.timestamp)}):r.msg.say?i.findByIdAndUpdate(e[1],{$push:{chatLog:{createdAt:Date.now(),msg:r.msg.say,user:e[3]}}},{},(t,r)=>{var n,o;n=e[1],o=r.users,i.findById(n,(e,t)=>{a.find({},(e,t)=>{s.find({},(e,t)=>{o.forEach(e=>{d.clients.forEach(t=>{const r=`session-${n}-user-${e}`;t.room.indexOf(r)>-1&&t.send(JSON.stringify({room:r,msg:{userState:void 0}}))})})})})})}):r.msg.commandQueues&&function(e){f.push(e)}(r):i.findByIdAndUpdate(e[1],{$push:{chatLog:r}},{},e=>{!function(e){d.clients.forEach(t=>{t.room.indexOf(e.room)>-1&&t.send(JSON.stringify(e))})}(r)}))}})});const f=[];function p(e,t,r){e.users.forEach(n=>{d.clients.forEach(o=>{const s=`session-${e._id}-user-${n}`;if(o.room.indexOf(s)>-1){const e=JSON.stringify({room:s,msg:t,timestamp:r});o.send(e),console.log("response time:",Date.now()-r)}})})}setTimeout((function e(){const t=f.shift();if(!t)return void setTimeout(e,0);const r=t.room.split("-");i.findById(r[1],(r,n)=>{u.updateState(n,t.msg.commandQueues);n.validate((function(r){r?console.log("invalid! ",r):(n.markModified("gameState"),n.save((function(r,o){setTimeout(e,0),r&&console.log("the error:",r),p(o,n.gameState,t.timestamp)})))}))})}),1)},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("passport-local-mongoose")},function(e,t,r){const n=r(17);e.exports=(e,t)=>{var r=e.gameState.dronesWithoutRays;return t.forEach(t=>{r=n(e,t,r)}),r}},function(e,t){e.exports=(e,t)=>e.gameState.dronesWithoutRays.map(e=>{if(e._id.toString()===t.droneId){if("DRONE_MOVE_FORWARD"===t.instruction){Math.round(e.x),Math.round(e.y);const t=e.x+.25*Math.cos(e.direction),r=e.y+.25*Math.sin(e.direction);Math.round(t),Math.round(r);e.x=t,e.y=r}if("DRONE_MOVE_BACK"===t.instruction){Math.round(e.x),Math.round(e.y);const t=e.x+-.25*Math.cos(e.direction),r=e.y+-.25*Math.sin(e.direction);Math.round(t),Math.round(r);e.x=t,e.y=r}"DRONE_ROTATE_LEFT"===t.instruction&&(e.direction=e.direction-.005),"DRONE_ROTATE_RIGHT"===t.instruction&&(e.direction=e.direction+.005)}return e})},function(e,t,r){const n=r(19),o=r(20),s=r(1),i=(r(21),r(5),r(22).Strategy),a=r(23),u=(r(0),r(9)),c=r(24);var d=r(25),f=r(26),p=r(27),l=r(29),m=r(31),h=s();h.set("views",c.join(__dirname,"views")),h.set("view engine","jade"),h.use(a("dev")),h.use(n.json()),h.use(n.urlencoded({extended:!1})),h.use(o()),h.use(r(33)({secret:"keyboard cat",resave:!1,saveUninitialized:!1})),h.use(u.initialize()),h.use(u.session()),h.use(s.static(c.join(__dirname,"public"))),h.use(s.static("dist")),h.use("/",d),h.use("/users",f),h.use("/sessions",p),h.use("/ships",l),h.use("/drones",m);var g=r(3);u.use(new i(g.authenticate())),u.serializeUser(g.serializeUser()),u.deserializeUser(g.deserializeUser()),h.use((function(e,t,r){var n=new Error("Not Found");n.status=404,r(n)})),h.use((function(e,t,r,n){r.locals.message=e.message,r.locals.error="development"===t.app.get("env")?e:{},r.status(e.status||500),r.render("error")})),e.exports=h},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("serve-favicon")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t,r){var n=r(1).Router(),o=r(10);n.get("/",o.home),n.get("/register",o.register),n.post("/register",o.doRegister),n.get("/login",o.login),n.post("/login",o.doLogin),n.get("/logout",o.logout),e.exports=n},function(e,t,r){var n=r(1).Router(),o=r(10);n.get("/allUsers",o.allUsers),e.exports=n},function(e,t,r){var n=r(1).Router(),o=r(28);n.get("/",o.allSessions),n.get("/new",o.newSession),n.post("/",o.createSession),n.get("/:id",o.showSession),n.get("/:id/terminal",o.terminal),n.post("/:id/start",o.start),e.exports=n},function(e,t,r){r(0);const n=r(6),o=r(2),s=r(3),i=r(4),a=r(7),u={home:function(e,t){t.render("index",{user:e.user})},allSessions:function(e,t){n.find({},(function(r,n){t.render("allSessions",{allSessions:n,user:e.user})}))},newSession:function(e,t){s.find({},(function(r,n){t.render("newSession",{allUsers:n,user:e.user})}))},createSession:function(e,t){new n(e.body).save().then(e=>{t.redirect(`sessions/${e.id}`)})},showSession:function(e,t){n.findById(e.params.id,(function(r,n){t.render("session",{session:n,user:e.user})}))},terminal:function(e,t){n.findById(e.params.id,(function(r,n){t.render("terminal",{session:n,user:e.user})}))},start:function(e,t){const r=e.params.id;e.params.userId;n.findById(r,(e,n)=>{o.find({},(e,o)=>{i.find({},(e,s)=>{a.initializeState(n,o.map(e=>e.toObject({virtuals:!0})),s.map(e=>e.toObject({virtuals:!0}))),n.save().then(e=>{t.redirect(`/sessions/${r}`)})})})})}};e.exports=u},function(e,t,r){var n=r(1),o=r(30),s=n.Router();s.get("/",o.allShips),s.post("/",o.create),s.get("/new",o.newShip),s.get("/:id",o.show),s.post("/:id",o.edit),e.exports=s},function(e,t,r){r(0);var n=r(2),o={allShips:function(e,t){n.find({},(function(r,n){t.render("ships",{allShips:n,user:e.user})}))},newShip:function(e,t){t.render("newShip",{user:e.user})},create:function(e,t){new n(e.body).save().then(e=>{t.redirect(`ships/${e.id}`)})},show:function(e,t){n.findById(e.params.id,(function(r,n){t.render("ship",{ship:n.toObject({virtuals:!0}),user:e.user})}))},edit:function(e,t){const r=e.body;n.findByIdAndUpdate(e.params.id,{},(function(n,o){if(r.name)o.name=r.name;else if(r.newRoomX){const e={name:r.newRoomName,x:parseInt(r.newRoomX),y:parseInt(r.newRoomY),x2:parseInt(r.newRoomX2),y2:parseInt(r.newRoomY2)};o.rooms.push(e)}else if(r.newDoorX){const e={name:r.newDoorName,x:parseInt(r.newDoorX),y:parseInt(r.newDoorY)};o.doors.push(e)}o.save(()=>{t.redirect(`${e.params.id}`)})}))}};e.exports=o},function(e,t,r){var n=r(1),o=r(32),s=n.Router();s.get("/",o.all),s.post("/",o.create),s.get("/new",o.new),s.get("/:id",o.show),s.post("/:id",o.edit),e.exports=s},function(e,t,r){r(0);var n=r(4),o=r(2),s={all:function(e,t){n.find({},(function(r,n){t.render("drones",{drones:n,user:e.user})}))},new:function(e,t){o.find({},(r,n)=>{t.render("newDrone",{user:e.user,ships:n})})},create:function(e,t){const r=new n(e.body);r.user=e.user.id,r.save().then(e=>{t.redirect(`drones/${e.id}`)})},show:function(e,t){n.findById(e.params.id,(function(r,n){t.render("Drone",{drone:n.toObject({virtuals:!0}),user:e.user})}))},edit:function(e,t){}};e.exports=s},function(e,t){e.exports=require("express-session")}]);