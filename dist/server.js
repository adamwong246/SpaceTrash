!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/Users/adam/Programming/spaceTrash/src/server",n(n.s=11)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t,n){var r=n(0),o=new r.Schema({name:String,x:Number,y:Number,x2:Number,y2:Number}),s=new r.Schema({name:String,x:Number,y:Number}),i=new r.Schema({name:String,rooms:[o],doors:[s]},{usePushEach:!0});i.virtual("shipMap").get((function(){if(this.rooms.length){var e={},t=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;this.rooms.forEach(e=>{for(var s=e.x;s<e.x2+2;s++)s<=t&&(t=s-1),s>=r&&(r=s+1);for(s=e.y;s<e.y2+2;s++)s<=n&&(n=s-1),s>=o&&(o=s+1)});for(var s=t;s<r;s++){e[s]=void 0===e[s]?{}:e[s];for(var i=n;i<o;i++)e[s][i]=" "}return this.rooms.forEach(t=>{for(var n=t.x;n<t.x2+1;n++)e[n]=void 0===e[n]?{}:e[n],e[n][t.y]="B",e[n][t.y2]="B";for(n=t.y;n<t.y2+1;n++)e[t.x]=void 0===e[t.x]?{}:e[t.x],e[t.x2]=void 0===e[t.x2]?{}:e[t.x2],e[t.x][n]="B",e[t.x2][n]="B";for(var r=t.x+1;r<t.x2;r++)for(var o=t.y+1;o<t.y2;o++)e[r][o]="f"}),this.doors.forEach(t=>{e[t.x][t.y]="d"}),{status:"ok",gridMap:e,xMin:t,xMax:r,yMin:n,yMax:o}}return{status:"no rooms"}})),e.exports=r.model("Ship",i)},function(e,t,n){var r=n(0),o=r.Schema,s=n(15),i=new o({username:String,password:String,name:String});i.plugin(s),e.exports=r.model("User",i)},function(e,t,n){var r=n(0),o=new r.Schema({name:String,x:Number,y:Number,direction:Number,ship:String,user:String});e.exports=r.model("Drone",o)},function(e,t){e.exports=require("http")},function(e,t,n){var r=n(0),o=new r.Schema({users:Array,chatLog:Array,name:String,gameState:{shipsWithoutFogOfWar:Array,dronesWithoutRays:Array}});e.exports=r.model("Session",o)},function(e,t,n){const r=n(8),o=n(16),s=(e,t)=>{e.gameState.shipsWithoutFogOfWar;e.gameState,e.userStates;var n=[];Object.keys(t).forEach(e=>{const r=t[e].map(t=>({droneId:e,timestamp:t.timestamp,instruction:t.instruction}));n=n.concat(r)});const r=n.sort(e=>e.timestamp);o(e,r)},i=e=>e.gameState.dronesWithoutRays.map(t=>{const n=e.gameState.shipsWithoutFogOfWar.filter(e=>t.ship===e.id)[0];return t.rays=r(t,n.matrix),t});e.exports={initializeState:(e,t,n)=>{((e,t,n)=>{const r={shipsWithoutFogOfWar:t.map(e=>{if(e.shipMap.gridMap){const r=e.shipMap.yMax-e.shipMap.yMin,o=e.shipMap.xMax-e.shipMap.xMin,s=2,i=new Array(r).fill("_").map(()=>new Array(o).fill("_").map(()=>new Array(s).fill("_")));for(var t=0;t<r;t++)for(var n=0;n<o;n++){const r=n+e.shipMap.xMin,o=t+e.shipMap.yMin;e.shipMap.gridMap[r][o]&&(i[t][n][0]=e.shipMap.gridMap[r][o])}e.matrix=i}return e}).map(e=>(e.matrix&&n.filter(t=>t.ship===e.id).forEach(t=>{e.matrix[Math.round(t.y)][Math.round(t.x)][1]=`drone-${t.id}`}),e)).map(e=>(e.x=0,e.y=0,e)),dronesWithoutRays:n};e.gameState=r})(e,t,n),(e=>{const t={};e.gameState.dronesWithoutRays.forEach(e=>{t[e.id]=[{instruction:"NO_OP",timestamp:Date.now()}]}),s(e,t),i(e)})(e)},updateState:(e,t)=>{const n=Date.now();s(e,t);const r=i(e);return console.log("update & render time:",Date.now()-n),{dronesWithRays:r}}}},function(e,t){var n=60*Math.PI/180;const r=Math.ceil(320);const o=160/Math.tan(n/2),s=2*Math.PI;e.exports=(e,t)=>{const n=t.length,i=t[0].length,a=t;return Array.from(Array(r).keys()).map((t,u)=>{var c=1*(-r/2+t),d=Math.sqrt(c*c+o*o),p=Math.asin(c/d);p+=e.direction;const f={id:u,style:{position:"absolute",src:"/walls_3.png",height:0,width:0,left:0,top:0,zIndex:0,clip:""},rayDistance:0,x:0,y:0};(p%=s)<0&&(p+=s);for(var l,m=p>.75*s||p<.25*s,h=p<0||p>Math.PI,g=Math.sin(p),y=Math.cos(p),x=0,S=0,v=0,M=!1,w=m?1:-1,b=w*(N=g/y),I=m?Math.ceil(e.x):Math.floor(e.x),O=e.y+(I-e.x)*N;I>=0&&I<i&&O>=0&&O<n;){const t=I+(m?0:-1)>>0,n=O>>0;if(a[n]&&a[n][t]&&"f"!==a[n][t][0]){x=(_=I-e.x)*_+(E=O-e.y)*E,l=O%1,m||(l=1-l),I,O,S=t,v=n,M=!0,!0;break}I+=w,O+=b}var N,A=h?-1:1,R=A*(N=y/g);for(O=h?Math.floor(e.y):Math.ceil(e.y),I=e.x+(O-e.y)*N;I>=0&&I<i&&O>=0&&O<n;){const t=O+(h?-1:0)>>0,n=I>>0;if("f"!==a[t][n][0]){var _,E,D=(_=I-e.x)*_+(E=O-e.y)*E;(!x||D<x)&&(x=D,I,O,S=n,v=t,l=I%1,h&&(l=1-l),M=!1);break}I+=R,O+=A}if(x){"d"===a[v][S][0]&&(f.style.src="/walls_4.png"),f.brenshams=((e,t,n,r,o)=>{var s=Math.abs(n-e),i=Math.abs(r-t),a=e<n?1:-1,u=t<r?1:-1,c=s-i;const d=[];for(;d.push({x:e,y:t,tile:o[t][e]}),e!==n||t!==r;){var p=2*c;p>-i&&(c-=i,e+=a),p<s&&(c+=s,t+=u)}return d})(Math.round(e.x),Math.round(e.y),S,v,a),x=Math.sqrt(x),x*=Math.cos(e.direction-p),f.rayDistance=x;var T=Math.round(o/x),j=1*T,B=Math.round((200-T)/2),W=Math.round(l*j);W>j-1&&(W=j-1),W+=M?j:0,f.style.height=T,f.style.width=2*j>>0,f.style.top=B-0,f.style.left=1*u-W,f.style.clip="rect(0px, "+(W+1)+"px, "+(0+T)+"px, "+W+"px)";var U=S-e.x,q=v-e.y,P=U*U+q*q;return f.style.zIndex=-1e3*P>>0,f.x=S,f.y=v,f}return f})}},function(e,t){e.exports=require("passport")},function(e,t,n){n(0);var r=n(9),o=n(3),s={home:function(e,t){t.render("index",{user:e.user})},register:function(e,t){t.render("register")},doRegister:function(e,t){o.register(new o({username:e.body.username,name:e.body.name}),e.body.password,(function(n,o){if(n)return t.render("register",{user:o});r.authenticate("local")(e,t,(function(){t.redirect("/")}))}))},login:function(e,t){t.render("login")},doLogin:function(e,t){r.authenticate("local")(e,t,(function(){t.redirect(e.header("Referer")||"/")}))},logout:function(e,t){e.logout(),t.redirect("/")},allUsers:function(e,t){o.find({},(function(n,r){t.render("allUsers",{allUsers:r,user:e.user})}))}};e.exports=s},function(e,t,n){n(12),n(13),e.exports=n(18)},function(e,t,n){var r=n(0);r.Promise=global.Promise,r.connect("mongodb://localhost/node-auth").then(()=>console.log("connection succesful")).catch(e=>console.error(e))},function(e,t,n){const r=n(5),o=n(14),s=n(4),i=n(6),a=n(2),u=(n(3),n(7)),c=(n(8),r.createServer({}));c.listen(5e3,()=>console.log("Web server start. http://localhost:5000"));const d=new o.Server({server:c});d.on("connection",e=>{e.send(JSON.stringify({msg:"user joined"})),console.log("connected"),e.room=[],e.on("error",e=>console.log(e)),e.on("close",e=>console.log("websocket closed"+e)),e.on("message",t=>{Date.now();var n=JSON.parse(t);if(n.createdAt=new Date,n.join&&e.room.push(n.join),n.room&&n.msg){const e=n.room.split("-");"session"===e[0]&&("user"===e[2]?n.msg.load?i.findById(e[1],(e,t)=>{f(t,t.gameState,n.msg.timestamp)}):n.msg.say?i.findByIdAndUpdate(e[1],{$push:{chatLog:{createdAt:Date.now(),msg:n.msg.say,user:e[3]}}},{},(t,n)=>{var r,o;r=e[1],o=n.users,i.findById(r,(e,t)=>{a.find({},(e,t)=>{s.find({},(e,t)=>{o.forEach(e=>{d.clients.forEach(t=>{const n=`session-${r}-user-${e}`;t.room.indexOf(n)>-1&&t.send(JSON.stringify({room:n,msg:{userState:void 0}}))})})})})})}):n.msg.commandQueues&&function(e){p.push(e)}(n):i.findByIdAndUpdate(e[1],{$push:{chatLog:n}},{},e=>{!function(e){d.clients.forEach(t=>{t.room.indexOf(e.room)>-1&&t.send(JSON.stringify(e))})}(n)}))}})});const p=[];function f(e,t,n){e.users.forEach(r=>{d.clients.forEach(o=>{const s=`session-${e._id}-user-${r}`;if(o.room.indexOf(s)>-1){const e=JSON.stringify({room:s,msg:t,timestamp:n});o.send(e),console.log("response time:",Date.now()-n)}})})}setTimeout((function e(){const t=p.shift();if(!t)return void setTimeout(e);const n=t.room.split("-");i.findById(n[1],(n,r)=>{u.updateState(r,t.msg.commandQueues);r.validate((function(n){n?console.log("invalid! ",n):(r.markModified("gameState"),r.save((function(n,o){setTimeout(e),n&&console.log("the error:",n),f(o,r.gameState,t.timestamp)})))}))})}))},function(e,t){e.exports=require("ws")},function(e,t){e.exports=require("passport-local-mongoose")},function(e,t,n){const r=n(17);e.exports=(e,t)=>{var n=e.gameState.dronesWithoutRays;return t.forEach(t=>{n=r(e,t,n)}),n}},function(e,t){e.exports=(e,t)=>e.gameState.dronesWithoutRays.map(e=>{if(e._id.toString()===t.droneId){if("DRONE_MOVE_FORWARD"===t.instruction){Math.round(e.x),Math.round(e.y);const t=e.x+.25*Math.cos(e.direction),n=e.y+.25*Math.sin(e.direction);Math.round(t),Math.round(n);e.x=t,e.y=n}if("DRONE_MOVE_BACK"===t.instruction){Math.round(e.x),Math.round(e.y);const t=e.x+-.25*Math.cos(e.direction),n=e.y+-.25*Math.sin(e.direction);Math.round(t),Math.round(n);e.x=t,e.y=n}"DRONE_ROTATE_LEFT"===t.instruction&&(e.direction=e.direction-.005),"DRONE_ROTATE_RIGHT"===t.instruction&&(e.direction=e.direction+.005)}return e})},function(e,t,n){const r=n(19),o=n(20),s=n(1),i=(n(21),n(5),n(22).Strategy),a=n(23),u=(n(0),n(9)),c=n(24);var d=n(25),p=n(26),f=n(27),l=n(29),m=n(31),h=s();h.set("views",c.join(__dirname,"views")),h.set("view engine","jade"),h.use(a("dev")),h.use(r.json()),h.use(r.urlencoded({extended:!1})),h.use(o()),h.use(n(33)({secret:"keyboard cat",resave:!1,saveUninitialized:!1})),h.use(u.initialize()),h.use(u.session()),h.use(s.static(c.join(__dirname,"public"))),h.use(s.static("dist")),h.use("/",d),h.use("/users",p),h.use("/sessions",f),h.use("/ships",l),h.use("/drones",m);var g=n(3);u.use(new i(g.authenticate())),u.serializeUser(g.serializeUser()),u.deserializeUser(g.deserializeUser()),h.use((function(e,t,n){var r=new Error("Not Found");r.status=404,n(r)})),h.use((function(e,t,n,r){n.locals.message=e.message,n.locals.error="development"===t.app.get("env")?e:{},n.status(e.status||500),n.render("error")})),e.exports=h},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("serve-favicon")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("path")},function(e,t,n){var r=n(1).Router(),o=n(10);r.get("/",o.home),r.get("/register",o.register),r.post("/register",o.doRegister),r.get("/login",o.login),r.post("/login",o.doLogin),r.get("/logout",o.logout),e.exports=r},function(e,t,n){var r=n(1).Router(),o=n(10);r.get("/allUsers",o.allUsers),e.exports=r},function(e,t,n){var r=n(1).Router(),o=n(28);r.get("/",o.allSessions),r.get("/new",o.newSession),r.post("/",o.createSession),r.get("/:id",o.showSession),r.get("/:id/clientApp",o.clientApp),r.get("/:id/clientSessionApp",o.clientSessionApp),r.get("/:id/clientSessionSudoApp",o.clientSessionSudoApp),r.post("/:id/start",o.start),e.exports=r},function(e,t,n){n(0);const r=n(6),o=n(2),s=n(3),i=n(4),a=n(7),u={home:function(e,t){t.render("index",{user:e.user})},allSessions:function(e,t){r.find({},(function(n,r){t.render("allSessions",{allSessions:r,user:e.user})}))},newSession:function(e,t){s.find({},(function(n,r){t.render("newSession",{allUsers:r,user:e.user})}))},createSession:function(e,t){new r(e.body).save().then(e=>{t.redirect(`sessions/${e.id}`)})},showSession:function(e,t){r.findById(e.params.id,(function(n,r){t.render("session",{session:r,user:e.user})}))},clientApp:function(e,t){r.findById(e.params.id,(function(n,r){t.render("clientApp",{session:r,user:e.user})}))},clientSessionApp:function(e,t){r.findById(e.params.id,(function(n,r){t.render("clientSessionApp",{session:r,user:e.user})}))},clientSessionSudoApp:function(e,t){r.findById(e.params.id,(function(n,r){t.render("clientSessionSudoApp",{session:r,user:e.user})}))},start:function(e,t){const n=e.params.id;e.params.userId;r.findById(n,(e,r)=>{o.find({},(e,o)=>{i.find({},(e,s)=>{a.initializeState(r,o.map(e=>e.toObject({virtuals:!0})),s.map(e=>e.toObject({virtuals:!0}))),r.save().then(e=>{t.redirect(`/sessions/${n}`)})})})})}};e.exports=u},function(e,t,n){var r=n(1),o=n(30),s=r.Router();s.get("/",o.allShips),s.post("/",o.create),s.get("/new",o.newShip),s.get("/:id",o.show),s.post("/:id",o.edit),e.exports=s},function(e,t,n){n(0);var r=n(2),o={allShips:function(e,t){r.find({},(function(n,r){t.render("ships",{allShips:r,user:e.user})}))},newShip:function(e,t){t.render("newShip",{user:e.user})},create:function(e,t){new r(e.body).save().then(e=>{t.redirect(`ships/${e.id}`)})},show:function(e,t){r.findById(e.params.id,(function(n,r){t.render("ship",{ship:r.toObject({virtuals:!0}),user:e.user})}))},edit:function(e,t){const n=e.body;r.findByIdAndUpdate(e.params.id,{},(function(r,o){if(n.name)o.name=n.name;else if(n.newRoomX){const e={name:n.newRoomName,x:parseInt(n.newRoomX),y:parseInt(n.newRoomY),x2:parseInt(n.newRoomX2),y2:parseInt(n.newRoomY2)};o.rooms.push(e)}else if(n.newDoorX){const e={name:n.newDoorName,x:parseInt(n.newDoorX),y:parseInt(n.newDoorY)};o.doors.push(e)}o.save(()=>{t.redirect(`${e.params.id}`)})}))}};e.exports=o},function(e,t,n){var r=n(1),o=n(32),s=r.Router();s.get("/",o.all),s.post("/",o.create),s.get("/new",o.new),s.get("/:id",o.show),s.post("/:id",o.edit),e.exports=s},function(e,t,n){n(0);var r=n(4),o=n(2),s={all:function(e,t){r.find({},(function(n,r){t.render("drones",{drones:r,user:e.user})}))},new:function(e,t){o.find({},(n,r)=>{t.render("newDrone",{user:e.user,ships:r})})},create:function(e,t){const n=new r(e.body);n.user=e.user.id,n.save().then(e=>{t.redirect(`drones/${e.id}`)})},show:function(e,t){r.findById(e.params.id,(function(n,r){t.render("Drone",{drone:r.toObject({virtuals:!0}),user:e.user})}))},edit:function(e,t){}};e.exports=s},function(e,t){e.exports=require("express-session")}]);